<div class="page-container">
  <div class="page-header">
    <h1>Clearance Monitoring</h1>
  </div>

  <!-- Organization Statistics Section -->
  <div class="stats-section" *ngIf="!isLoadingStats()">
    <div class="stats-header">
      <h2>Organization Statistics</h2>
      <button class="btn-toggle" (click)="toggleStats()">
        {{ showStats() ? 'Hide' : 'Show' }} Statistics
      </button>
    </div>

    <div class="stats-cards" *ngIf="showStats()">
      <div class="stat-card" *ngFor="let stat of orgStats()">
        <div class="stat-card-header">
          <h3>{{ stat.org_name }}</h3>
          <span class="org-code">{{ stat.org_code }}</span>
        </div>
        <div class="stat-card-body">
          <div class="stat-item">
            <span class="stat-label">Total Clearances</span>
            <span class="stat-value">{{ stat.total_clearances }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Approved</span>
            <span class="stat-value approved">{{ stat.approved }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pending</span>
            <span class="stat-value pending">{{ stat.pending }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Needs Compliance</span>
            <span class="stat-value needs-compliance">{{ stat.needs_compliance }}</span>
          </div>
        </div>
        <div class="stat-card-footer">
          <span class="approval-rate">Approval Rate: {{ getApprovalRate(stat) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="content-card">
    <!-- Search and Filters -->
    <div class="search-filters">
      <input
        type="text"
        placeholder="Search by student name or number..."
        class="search-input"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearch()"
      >
      <select class="filter-select" [(ngModel)]="overallStatusFilter" (ngModelChange)="onFilterChange()">
        <option value="all">All Status</option>
        <option value="approved">Approved</option>
        <option value="pending">Pending</option>
        <option value="incomplete">Incomplete</option>
      </select>
      <select class="filter-select" [(ngModel)]="termFilter" (ngModelChange)="onFilterChange()">
        <option [value]="'all'">All Terms</option>
        <option *ngFor="let term of terms()" [value]="term.term_id">
          {{ term.term_name }} ({{ term.term_code }})
        </option>
      </select>
      <input
        type="text"
        placeholder="Filter by program..."
        class="filter-input"
        [(ngModel)]="programFilter"
        (ngModelChange)="onFilterChange()"
      >
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage()" class="error-message">
      {{ errorMessage() }}
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading clearances...</p>
    </div>

    <!-- Clearances Table -->
    <div *ngIf="!isLoading() && clearances().length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th>Student Number</th>
            <th>Student Name</th>
            <th>Program</th>
            <th>Term</th>
            <th>Overall Status</th>
            <th>Progress</th>
            <th>Created Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let clearance of clearances()">
            <td>{{ clearance.student?.student_number || 'N/A' }}</td>
            <td>{{ getStudentFullName(clearance) }}</td>
            <td>{{ clearance.student?.program || 'N/A' }}</td>
            <td>{{ clearance.term?.term_name || 'N/A' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(clearance.overall_status)">
                {{ clearance.overall_status }}
              </span>
            </td>
            <td>
              <span class="progress-text">{{ getProgressText(clearance) }}</span>
            </td>
            <td>{{ formatDate(clearance.created_at) }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-view" (click)="openDetailsModal(clearance)">View Details</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Showing {{ (currentPage() - 1) * perPage() + 1 }} to {{ Math.min(currentPage() * perPage(), total()) }} of {{ total() }} clearances
        </div>
        <div class="pagination-buttons">
          <button
            class="pagination-btn"
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
          >
            Previous
          </button>
          <span class="page-info">Page {{ currentPage() }} of {{ totalPages() }}</span>
          <button
            class="pagination-btn"
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && clearances().length === 0" class="placeholder-state">
      <div class="placeholder-icon">âœ…</div>
      <h3>No Clearances Found</h3>
      <p>No clearances match your current filters.</p>
      <p class="note">Try adjusting your search criteria.</p>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div *ngIf="showDetailsModal()" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Clearance Details</h2>
      <button class="modal-close" (click)="closeDetailsModal()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Overall Clearance Information -->
      <div class="clearance-info" *ngIf="selectedClearance()">
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Student Name:</span>
            <span class="info-value">{{ getStudentFullName(selectedClearance()!) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Student Number:</span>
            <span class="info-value">{{ selectedClearance()!.student?.student_number || 'N/A' }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Program:</span>
            <span class="info-value">{{ selectedClearance()!.student?.program || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Year Level:</span>
            <span class="info-value">{{ selectedClearance()!.student?.year_level || 'N/A' }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Term:</span>
            <span class="info-value">{{ selectedClearance()!.term?.term_name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Overall Status:</span>
            <span class="status-badge" [ngClass]="getStatusClass(selectedClearance()!.overall_status)">
              {{ selectedClearance()!.overall_status }}
            </span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Created Date:</span>
            <span class="info-value">{{ formatDate(selectedClearance()!.created_at) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Last Updated:</span>
            <span class="info-value">{{ formatDate(selectedClearance()!.last_updated) }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-item">
            <span class="info-label">Approved Date:</span>
            <span class="info-value">{{ formatDate(selectedClearance()!.approved_date) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Is Locked:</span>
            <span class="info-value">{{ selectedClearance()!.is_locked ? 'Yes' : 'No' }}</span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Clearance Items Loading -->
      <div *ngIf="isLoadingItems()" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading clearance items...</p>
      </div>

      <!-- Clearance Items Table -->
      <div *ngIf="!isLoadingItems() && clearanceItems().length > 0">
        <h3 class="items-title">Clearance Items</h3>
        <table class="items-table">
          <thead>
            <tr>
              <th>Organization</th>
              <th>Status</th>
              <th>Auto Approved</th>
              <th>Approver</th>
              <th>Approved Date</th>
              <th>Status Updated</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of clearanceItems()">
              <td>
                <div class="org-cell">
                  <span class="org-name">{{ item.organization?.org_name || 'N/A' }}</span>
                  <span class="org-code-small">{{ item.organization?.org_code || '' }}</span>
                </div>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                  {{ item.status }}
                </span>
              </td>
              <td>
                <span class="auto-approved">{{ item.is_auto_approved ? 'Yes' : 'No' }}</span>
              </td>
              <td>{{ getApproverFullName(item) }}</td>
              <td>{{ formatDateTime(item.approved_date) }}</td>
              <td>{{ formatDateTime(item.status_updated) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty Items State -->
      <div *ngIf="!isLoadingItems() && clearanceItems().length === 0" class="empty-items">
        <p>No clearance items found.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>
