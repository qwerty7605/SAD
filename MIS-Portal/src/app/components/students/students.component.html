<div class="page-container">
  <div class="page-header">
    <h1>Student Management</h1>
    <button class="btn-primary" (click)="openCreateModal()">Add Student</button>
  </div>

  <div class="content-card">
    <!-- Search and Filters -->
    <div class="search-filters">
      <input
        type="text"
        placeholder="Search by name, email, or student number..."
        class="search-input"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearch()"
      >
      <select class="filter-select" [(ngModel)]="statusFilter" (ngModelChange)="onFilterChange()">
        <option value="all">All Enrollment Status</option>
        <option value="enrolled">Enrolled</option>
        <option value="inactive">Inactive</option>
        <option value="graduated">Graduated</option>
        <option value="withdrawn">Withdrawn</option>
      </select>
      <input
        type="text"
        placeholder="Course..."
        class="filter-input"
        [(ngModel)]="courseFilter"
        (ngModelChange)="onFilterChange()"
      >
      <select class="filter-select" [(ngModel)]="yearLevelFilter" (ngModelChange)="onFilterChange()">
        <option value="">All Years</option>
        <option [value]="1">1st Year</option>
        <option [value]="2">2nd Year</option>
        <option [value]="3">3rd Year</option>
        <option [value]="4">4th Year</option>
        <option [value]="5">5th Year</option>
      </select>
      <select class="filter-select" [(ngModel)]="studentTypeFilter" (ngModelChange)="onFilterChange()">
        <option value="all">All Types</option>
        <option value="regular">Regular</option>
        <option value="irregular">Irregular</option>
      </select>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage()" class="error-message">
      {{ errorMessage() }}
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading students...</p>
    </div>

    <!-- Students Table -->
    <div *ngIf="!isLoading() && students().length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th>Student Number</th>
            <th>Name</th>
            <th>Email</th>
            <th>Course</th>
            <th>Year Level</th>
            <th>Type</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let student of students()">
            <td>{{ student.student_number }}</td>
            <td>{{ getFullName(student) }}</td>
            <td>{{ student.user?.email }}</td>
            <td>{{ student.course }}</td>
            <td>{{ student.year_level }}</td>
            <td>
              <span class="badge" [class.regular]="student.student_type === 'regular'" [class.irregular]="student.student_type === 'irregular'">
                {{ student.student_type }}
              </span>
            </td>
            <td>
              <span class="status-badge"
                [class.enrolled]="student.enrollment_status === 'enrolled'"
                [class.inactive]="student.enrollment_status === 'inactive'"
                [class.graduated]="student.enrollment_status === 'graduated'"
                [class.withdrawn]="student.enrollment_status === 'withdrawn'">
                {{ student.enrollment_status | titlecase }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-edit" (click)="openEditModal(student)">Edit</button>
                <button class="btn-delete" (click)="openDeleteModal(student)">Delete</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Showing {{ (currentPage() - 1) * perPage() + 1 }} to {{ Math.min(currentPage() * perPage(), total()) }} of {{ total() }} students
        </div>
        <div class="pagination-buttons">
          <button
            class="pagination-btn"
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
          >
            Previous
          </button>
          <span class="page-info">Page {{ currentPage() }} of {{ totalPages() }}</span>
          <button
            class="pagination-btn"
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && students().length === 0" class="placeholder-state">
      <div class="placeholder-icon">üë®‚Äçüéì</div>
      <h3>No Students Found</h3>
      <p>No students match your current filters.</p>
      <p class="note">Try adjusting your search criteria or add a new student.</p>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div *ngIf="showModal()" class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalMode() === 'create' ? 'Add New Student' : 'Edit Student' }}</h2>
      <button class="modal-close" (click)="closeModal()">&times;</button>
    </div>

    <form (ngSubmit)="onSubmit()">
      <div class="modal-body">
        <div class="form-section">
          <h3>Account Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="username">Username *</label>
              <input
                type="text"
                id="username"
                [(ngModel)]="formData().username"
                name="username"
                required
                [disabled]="modalMode() === 'edit'"
              >
            </div>
            <div class="form-group">
              <label for="email">Email *</label>
              <input
                type="email"
                id="email"
                [(ngModel)]="formData().email"
                name="email"
                required
              >
            </div>
          </div>
          <div class="form-row" *ngIf="modalMode() === 'create'">
            <div class="form-group">
              <label for="password">Password *</label>
              <input
                type="password"
                id="password"
                [(ngModel)]="formData().password"
                name="password"
                [required]="modalMode() === 'create'"
              >
            </div>
          </div>
          <div class="form-row" *ngIf="modalMode() === 'edit'">
            <div class="form-group">
              <label for="password">New Password (leave blank to keep current)</label>
              <input
                type="password"
                id="password"
                [(ngModel)]="formData().password"
                name="password"
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Personal Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="student_number">Student Number *</label>
              <input
                type="text"
                id="student_number"
                [(ngModel)]="formData().student_number"
                name="student_number"
                required
              >
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="first_name">First Name *</label>
              <input
                type="text"
                id="first_name"
                [(ngModel)]="formData().first_name"
                name="first_name"
                required
              >
            </div>
            <div class="form-group">
              <label for="middle_name">Middle Name</label>
              <input
                type="text"
                id="middle_name"
                [(ngModel)]="formData().middle_name"
                name="middle_name"
              >
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="last_name">Last Name *</label>
              <input
                type="text"
                id="last_name"
                [(ngModel)]="formData().last_name"
                name="last_name"
                required
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Academic Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="course">Course *</label>
              <input
                type="text"
                id="course"
                [(ngModel)]="formData().course"
                name="course"
                required
                placeholder="e.g., Bachelor of Science in Information Technology"
              >
            </div>
            <div class="form-group">
              <label for="year_level">Year Level *</label>
              <select
                id="year_level"
                [(ngModel)]="formData().year_level"
                name="year_level"
                required
              >
                <option [value]="1">1st Year</option>
                <option [value]="2">2nd Year</option>
                <option [value]="3">3rd Year</option>
                <option [value]="4">4th Year</option>
                <option [value]="5">5th Year</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="section">Section</label>
              <input
                type="text"
                id="section"
                [(ngModel)]="formData().section"
                name="section"
              >
            </div>
            <div class="form-group">
              <label for="student_type">Student Type *</label>
              <select
                id="student_type"
                [(ngModel)]="formData().student_type"
                name="student_type"
                required
              >
                <option value="regular">Regular</option>
                <option value="irregular">Irregular</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Contact Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="contact_number">Contact Number</label>
              <input
                type="text"
                id="contact_number"
                [(ngModel)]="formData().contact_number"
                name="contact_number"
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Status</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="enrollment_status">Enrollment Status *</label>
              <select
                id="enrollment_status"
                [(ngModel)]="formData().enrollment_status"
                name="enrollment_status"
                required
              >
                <option value="enrolled">Enrolled</option>
                <option value="inactive">Inactive</option>
                <option value="graduated">Graduated</option>
                <option value="withdrawn">Withdrawn</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-submit">
          {{ modalMode() === 'create' ? 'Create Student' : 'Update Student' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal()" class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="modal-close" (click)="closeDeleteModal()">&times;</button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to delete this student?</p>
      <p class="delete-info">
        <strong>{{ getFullName(studentToDelete()!) }}</strong><br>
        Student Number: {{ studentToDelete()?.student_number }}
      </p>
      <p class="warning">This action cannot be undone.</p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn-delete-confirm" (click)="confirmDelete()">Delete Student</button>
    </div>
  </div>
</div>
