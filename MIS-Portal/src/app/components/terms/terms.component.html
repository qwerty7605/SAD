<div class="page-container">
  <div class="page-header">
    <h1>Academic Term Management</h1>
    <button class="btn-primary" (click)="openCreateModal()">Add Term</button>
  </div>

  <div class="content-card">
    <!-- Search and Filters -->
    <div class="search-filters">
      <input
        type="text"
        placeholder="Search by term name or academic year..."
        class="search-input"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearch()"
      >
      <select class="filter-select" [(ngModel)]="semesterFilter" (ngModelChange)="onFilterChange()">
        <option value="all">All Semesters</option>
        <option value="first">First Semester</option>
        <option value="second">Second Semester</option>
        <option value="summer">Summer</option>
      </select>
      <select class="filter-select" [(ngModel)]="isCurrentFilter" (ngModelChange)="onFilterChange()">
        <option value="all">All Terms</option>
        <option value="yes">Current Only</option>
        <option value="no">Not Current</option>
      </select>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage()" class="error-message">
      {{ errorMessage() }}
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading academic terms...</p>
    </div>

    <!-- Terms Table -->
    <div *ngIf="!isLoading() && terms().length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th>Term Name</th>
            <th>Academic Year</th>
            <th>Semester</th>
            <th>Start - End Dates</th>
            <th>Enrollment Period</th>
            <th>Current</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let term of terms()" [class.current-term]="term.is_current">
            <td>{{ term.term_name }}</td>
            <td>{{ term.academic_year }}</td>
            <td>
              <span class="semester-badge" [class.first]="term.semester === 'first'" [class.second]="term.semester === 'second'" [class.summer]="term.semester === 'summer'">
                {{ term.semester === 'first' ? 'First' : term.semester === 'second' ? 'Second' : 'Summer' }}
              </span>
            </td>
            <td>{{ getDuration(term) }}</td>
            <td>{{ formatDate(term.enrollment_start) }} - {{ formatDate(term.enrollment_end) }}</td>
            <td>
              <span *ngIf="term.is_current" class="current-badge">Current</span>
              <span *ngIf="!term.is_current" class="not-current-text">-</span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn-set-current"
                  (click)="openSetCurrentModal(term)"
                  [disabled]="term.is_current"
                  [title]="term.is_current ? 'Already the current term' : 'Set as current term'"
                >
                  {{ term.is_current ? 'Current' : 'Set Current' }}
                </button>
                <button class="btn-edit" (click)="openEditModal(term)">Edit</button>
                <button
                  class="btn-delete"
                  (click)="openDeleteModal(term)"
                  [disabled]="!canDelete(term)"
                  [title]="!canDelete(term) ? 'Cannot delete the current term' : 'Delete term'"
                >
                  Delete
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Showing {{ (currentPage() - 1) * perPage() + 1 }} to {{ Math.min(currentPage() * perPage(), total()) }} of {{ total() }} terms
        </div>
        <div class="pagination-buttons">
          <button
            class="pagination-btn"
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
          >
            Previous
          </button>
          <span class="page-info">Page {{ currentPage() }} of {{ totalPages() }}</span>
          <button
            class="pagination-btn"
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
          >
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && terms().length === 0" class="placeholder-state">
      <div class="placeholder-icon">ðŸ“…</div>
      <h3>No Academic Terms Found</h3>
      <p>No academic terms match your current filters.</p>
      <p class="note">Try adjusting your search criteria or add a new term.</p>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div *ngIf="showModal()" class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalMode() === 'create' ? 'Add New Academic Term' : 'Edit Academic Term' }}</h2>
      <button class="modal-close" (click)="closeModal()">&times;</button>
    </div>

    <form (ngSubmit)="onSubmit()">
      <div class="modal-body">
        <div class="form-section">
          <h3>Term Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="term_name">Term Name *</label>
              <input
                type="text"
                id="term_name"
                [(ngModel)]="formData().term_name"
                name="term_name"
                required
                placeholder="e.g., First Semester AY 2024-2025"
              >
            </div>
            <div class="form-group">
              <label for="academic_year">Academic Year *</label>
              <input
                type="text"
                id="academic_year"
                [(ngModel)]="formData().academic_year"
                name="academic_year"
                required
                placeholder="e.g., 2024-2025"
              >
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="semester">Semester *</label>
              <select
                id="semester"
                [(ngModel)]="formData().semester"
                name="semester"
                required
              >
                <option value="first">First</option>
                <option value="second">Second</option>
                <option value="summer">Summer</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Term Duration</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="start_date">Start Date *</label>
              <input
                type="date"
                id="start_date"
                [(ngModel)]="formData().start_date"
                name="start_date"
                required
              >
            </div>
            <div class="form-group">
              <label for="end_date">End Date *</label>
              <input
                type="date"
                id="end_date"
                [(ngModel)]="formData().end_date"
                name="end_date"
                required
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Enrollment Period</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="enrollment_start">Enrollment Start *</label>
              <input
                type="date"
                id="enrollment_start"
                [(ngModel)]="formData().enrollment_start"
                name="enrollment_start"
                required
              >
            </div>
            <div class="form-group">
              <label for="enrollment_end">Enrollment End *</label>
              <input
                type="date"
                id="enrollment_end"
                [(ngModel)]="formData().enrollment_end"
                name="enrollment_end"
                required
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Clearance</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="clearance_deadline">Clearance Deadline (Optional)</label>
              <input
                type="date"
                id="clearance_deadline"
                [(ngModel)]="formData().clearance_deadline"
                name="clearance_deadline"
              >
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Settings</h3>
          <div class="form-row checkbox-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [(ngModel)]="formData().is_current"
                  name="is_current"
                >
                Set as Current Term
              </label>
              <p class="checkbox-help">Only one term can be current at a time</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-submit">
          {{ modalMode() === 'create' ? 'Create Term' : 'Update Term' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal()" class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="modal-close" (click)="closeDeleteModal()">&times;</button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to delete this academic term?</p>
      <p class="delete-info">
        <strong>{{ termToDelete()?.term_name }}</strong><br>
        Academic Year: {{ termToDelete()?.academic_year }}<br>
        Semester: {{ termToDelete()?.semester }}
      </p>
      <p class="warning">This action cannot be undone and may affect related clearance records.</p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn-delete-confirm" (click)="confirmDelete()">Delete Term</button>
    </div>
  </div>
</div>

<!-- Set Current Term Confirmation Modal -->
<div *ngIf="showSetCurrentModal()" class="modal-overlay" (click)="closeSetCurrentModal()">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Set Current Term</h2>
      <button class="modal-close" (click)="closeSetCurrentModal()">&times;</button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to set this as the current academic term?</p>
      <p class="delete-info">
        <strong>{{ termToSetCurrent()?.term_name }}</strong><br>
        Academic Year: {{ termToSetCurrent()?.academic_year }}<br>
        Semester: {{ termToSetCurrent()?.semester }}
      </p>
      <p class="info">This will automatically unset any other term that is currently marked as current.</p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeSetCurrentModal()">Cancel</button>
      <button type="button" class="btn-submit" (click)="confirmSetCurrent()">Set as Current</button>
    </div>
  </div>
</div>
